function trimStr(e){return e.replace(/(^\s*)|(\s*$)/g,"")}function Shownotice(e,t,n){n=="enabled"?chrome.runtime.sendMessage({cmd:"create1"},function(e){}):e=="enabled"&&chrome.runtime.sendMessage({cmd:"create1"},function(e){})}function Time(){try{for(var e=1;e<trs.length;e++){var t=trs[e].getElementsByTagName("td"),n=t[8].innerHTML,r=t[7].innerHTML,i=Convertday(r,n);i=i.split(",");for(var s=0;s<i.length-1;s++){if(busytime.indexOf(i[s])>=0){trs[e].style.color="#C2C2C2";break}trs[e].style.color="black"}var o=t[2].innerHTML;for(s=0;s<courseinfo.length;s++)o==courseinfo[s].course&&r==courseinfo[s].coursetime&&n==courseinfo[s].courseterm&&(trs[e].style.color="black");trs[e].style.color=="rgb(194, 194, 194)"&&(trs[e].onmouseout=function(){this.style.color="#C2C2C2"},trs[e].onmouseover=function(){this.style.color="#8B8B8B"})}}catch(u){errorHandler("时间冲突判断模块错误！",u)}}function Highlight(){for(var e=1;e<trs.length;e++){var t=trs[e].getElementsByTagName("td");trs[e].style.color=="black"&&(trs[e].style.backgroundColor="#CBFFBF",trs[e].onmouseout=function(){this.style.backgroundColor="#CBFFBF"},trs[e].onmouseover=function(){this.style.backgroundColor="#ACFF9B"})}}function Changecursor(){this.style.cursor="pointer"}function ChangeTitle(){var e=trs[0].insertCell(1);e.style.width="10%",e.innerHTML="评分/人数";for(var t=1;t<=trs.length-1;t++)e=trs[t].insertCell(1),e.innerHTML="";for(var t=0;t<=trs.length-1;t++){var n=trs[t].getElementsByTagName("td");trs[t].removeChild(n[8])}}function Sort(e,t,n){var r=tdstitle[e].innerHTML;r=r.replace("▼",""),r=r.replace("▲",""),n==0?(sortTable("DataGrid1",e,t),sort++,sort%2==0?tdstitle[e].innerHTML=r+"▲":tdstitle[e].innerHTML=r+"▼"):tdstitle[e].innerHTML=r+"▼"}function AddSort(e){tdstitle=trs[0].getElementsByTagName("td"),chrome.runtime.sendMessage({key:"Showinfo"},function(e){e==1&&swal("教师排序模块已激活","现在你可以点击表头的相应文字对所有教师进行排序，同时点击教师评分和均绩可进入学习帝查看评论详情~","info")}),tdstitle[0].onmouseover=Changecursor,tdstitle[0].onclick=function(){Sort(0,"string",!1)},Sort(0,"string",!0),e===1&&(tdstitle[1].onmouseover=Changecursor,tdstitle[1].onclick=function(){Sort(1,"string",!1)},Sort(1,"string",!0)),tdstitle[1+e].onmouseover=Changecursor,tdstitle[1+e].onclick=function(){Sort(1+e,"string",!1)},Sort(1+e,"string",!0),tdstitle[2+e].onmouseover=Changecursor,tdstitle[2+e].onclick=function(){Sort(2+e,"string",!1)},Sort(2+e,"string",!0),tdstitle[3+e].onmouseover=Changecursor,tdstitle[3+e].onclick=function(){Sort(3+e,"string",!1)},Sort(3+e,"string",!0),tdstitle[5+e].onmouseover=Changecursor,tdstitle[5+e].onclick=function(){Sort(5+e,"string",!1)},Sort(5+e,"string",!0),tdstitle[6+e].onmouseover=Changecursor,tdstitle[6+e].onclick=function(){Sort(6+e,"string",!1)},Sort(6+e,"string",!0),tdstitle[7+e].onmouseover=Changecursor,tdstitle[7+e].onclick=function(){Sort(7+e,"string",!1)},Sort(7+e,"string",!0)}function getScoresAll(){var e=[];$.each(trs,function(t,n){if(t!==0){var r=n.innerHTML;r=r.match(/target="_blank">.{1,}<\/a>/),r=r[0].match(/>.{1,}</),r=r[0].match(/[\u4e00-\u9fa5a-zA-Z\s]{1,}/),e.push(r[0])}}),$.ajax({type:"POST",dataType:"json",data:{student:student,teacher:JSON.stringify(e)},url:"https://enroll.zjuqsc.com/user/quickSearch",error:function(){swal("服务器响应超时","貌似最近访问的人太多了，服务器忙不过来啦~","error")},success:function(e){if(e.success===0){var t=e.data;$.each(trs,function(e,n){if(e!==0){var r=n.innerHTML;r=r.match(/target="_blank">.{1,}<\/a>/),r=r[0].match(/>.{1,}</),r=r[0].match(/[\u4e00-\u9fa5a-zA-Z\s]{1,}/),r=r[0];var i=trs[e].getElementsByTagName("td"),s;for(var o=0;o<t.length;o++)if(r===t[o].Name)break;if(o>=t.length)score="0.00",scorenum=0;else{var u=t[o];try{var a=u.tea_id;score=u.Score,score=="N/A"&&(score="0.00"),scorenum=u.AssessNum}catch(f){score="0.00"}score==null&&(score="0.00"),scorenum==null&&(scorenum=0)}s='<div style="height:15px"></div>',i[1].innerHTML=score+"/"+scorenum,i[1].onclick=function(){window.open("http://chalaoshi.cn/teacher/"+a+"/")},i[1].onmouseover=Changecursor,$(i[0]).append(s),score>8.6?i[1].style.color="red":i[1].style.color=""}})}AddSort(1)}})}function quickCheckTime(e){try{NProgress.inc(),$.ajax({type:"GET",timeout:5e3,url:adjustinner+"/xskbcx.aspx?xh="+e,error:function(e,t,n){swal("获取课表错误！","呜呜……选课助手发现教务网好像出了什么问题~主人快检查下能否正常进入教务网哦~","error")},success:function(e){NProgress.done(),e=e.match(/<A href='#' onclick="window.open\('.{1,}','kcb','toolbar=0,location=0,directories=0,status=0,menubar=0,scrollbars=1,resizable=1'\)">(<i><font color=red>){0,1}.{1,}(<\/font><\/i>){0,1}<\/a><\/td><td>.{1,}<\/td><td>.{1,}<\/td><td>.{1,}<\/td><td>.{1,}<\/td><td>.{1,}<\/td>/ig);for(var t=0;t<e.length;t++){var n=e[t].match(/<A href='#' onclick="window.open\('.{1,}','kcb','toolbar=0,location=0,directories=0,status=0,menubar=0,scrollbars=1,resizable=1'\)">(<i><font color=red>){0,1}[0-9A-Z]{8}(<\/font><\/i>){0,1}<\/A>/g);n=n[0].match(/[0-9A-Z]{8}/),n=n[0];try{var r=e[t].match(/<td>[\u4e00-\u9fa5]{1,2}<\/td>/);r=r[0].match(/[\u4e00-\u9fa5]{1,2}/),r=r[0]}catch(i){r="0"}try{var s=e[t].match(/周[\u4e00-\u9fa5]{1}第.{1,}节.{0,4}<\/td>/g);s=s[0],s=s.replace("</td>","")}catch(i){s="0"}courseinfo[t]={course:n,courseterm:r,coursetime:s},console.log(courseinfo[t]),s!="0"&&r!="0"&&(busytime+=Convertday(s,r))}Time(),Highlight()}})}catch(t){errorHandler("上课时间获取模块错误！",t)}}function Main(){if(item!=null){$("#CheckBox1").attr("checked",!0);try{chrome.runtime.sendMessage({cmd:"create1"},function(e){}),ChangeTitle(),getScoresAll(),quickCheckTime(student)}catch(e){errorHandler("Main函数错误！",e)}}}function errorHandler(e,t){console.log(t),swal(e,"呜呜……/(ㄒoㄒ)/~选课助手崩溃啦，崩溃日志已经被上传到服务器，请等待作者回应。您还可以联系作者详细描述错误情形以帮助改进插件~\n\n错误信息：\n"+t,"error"),$.ajax({url:"https://enroll.zjuqsc.com/user/errfeedback",timeout:3e3,type:"POST",dataType:"json",data:{errname:t.name,errmessage:t.message,errlog:t.stack,userAgent:navigator.userAgent,stuid:student,version:nowver},cache:!1})}var item=document.getElementById("DataGrid1");if(item!=null)var tbody=item.getElementsByTagName("tbody")[0],trs=tbody.getElementsByTagName("tr"),courseinfo=[],busytime="",progress=0,id,Showscore,ShowGPA,Timecheck,Sparecheck,student,permit=0,sort=0,tdstitle,adjustinner;adjustinner=window.document.location.origin;try{student=document.getElementById("cxbmform").action,student=student.match(/\?xh=\d{1,}/),student=student[0].match(/\d{1,}/),student=student[0],chrome.runtime.sendMessage({cmd:"Stu",data:student},function(e){})}catch(err){errorHandler("获取学号信息错误！",err)}chrome.runtime.sendMessage({key:"update"},function(e){console.log(e);try{upenabledvalue=e.upenabled}catch(t){upenabledvalue=0}nowver=e.nowver,upenabledvalue==1&&swal({title:"检测到主程序更新",text:"选课助手要更新啦~点击确定下载~记得安装哦！！\n\n当前版本："+e.nowver+"\n\n最新版本："+e.latestver+"\n\n为保证用户体验，插件需要更新才能使用哦~",type:"info",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"开始升级",cancelButtonText:"取消升级",closeOnCancel:!1},function(t){t?window.open(e.updateurl):swal({title:"取消升级",text:"为保证用户体验，插件需升级到最新版本才可使用，确认要取消吗？点击取消将打开升级页面",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"确定",cancelButtonText:"取消"},function(t){t||window.open(e.updateurl)})})}),chrome.runtime.sendMessage({key:"Genuine"},function(e){if(e==0)swal("主程序错误！","检测到插件被二次打包！\n为保护作者版权，请重新下载官方版本！\n下载地址："+res.updateurl,"error");else try{chrome.runtime.sendMessage({key:"Getsettings"},function(e){e=e.split(","),Showscore=e[0],ShowGPA=e[1],Timecheck=e[2],permit=1,Showscore=="enabled"||ShowGPA=="enabled"?permit==1?(chrome.runtime.sendMessage({cmd:"clear"},function(e){}),Main()):permit==0&&(Showscore="disabled",ShowGPA="disabled",chrome.runtime.sendMessage({cmd:"clear"},function(e){}),Main()):(NProgress.done(),chrome.runtime.sendMessage({cmd:"clear"},function(e){}),Main())})}catch(t){errorHandler("主程序错误！",t)}});