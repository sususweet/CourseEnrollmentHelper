function Main(){try{title=$(".leaf");if(title.length===0)return setTimeout(Main,1e3);$("#outer_xkxx").length>0;for(var e=0;e<title.length;e++){var t=$(title.get(e)).find(".dropdown-menu"),n;if(t.length==0)n=title.get(e),n.addEventListener("click",function(){doScrollCheck2()});else{n=$(t).find("li");for(var r=0;r<n.length;r++)n.get(r).addEventListener("click",function(){doScrollCheck2()})}}var i=$(".jump");$.each(i,function(e,t,n){t.addEventListener("click",function(){var e=$("#btn_cxjxb").get(0);if(!e)return setTimeout(doScrollCheck2,1e3)})}),doScrollCheck2()}catch(s){errorHandler("Main 函数错误！",s)}}function WaitForReady(){try{title=$(".leaf");if(title.length===0)return setTimeout(WaitForReady,1e3);console.log(title)}catch(e){errorHandler("WaitForReady 函数错误！",e)}}function doScrollCheck2(){courseitem=$(".panel-info");if(courseitem.length==0)return setTimeout(doScrollCheck2,1e3);search_button=$("#btn_cxjxb").get(0),search_button&&search_button.getAttribute("addClick")!=1&&(search_button.addEventListener("click",function(){doScrollCheck2()}),search_button.setAttribute("addClick",1)),Addbtn(),isnext=$("#nextPage").get(0),isnext!=null&&isnext.style.display!="none"&&isnext.getAttribute("addClick")!=1&&(isnext.addEventListener("click",function(){doScrollCheck2()}),isnext.setAttribute("addClick",1))}function Addbtn(){try{if($(courseitem[0]).find(".nodata").length!=0)return;var e=$(courseitem[0]).find(".kc_head").get(0);if(e.getAttribute("state")==null){e.setAttribute("state",0);var t=function(){if($(e).parent().find("tbody").get(0).childElementCount===0)return setTimeout(t,1e3);Superlookup(0,e.getAttribute("state")),e.setAttribute("state",1)};t()}for(var n=1;n<courseitem.length;n++){var r=$(courseitem[n]).find(".kc_head").get(0);r.getAttribute("state")==null&&(r.setAttribute("checkid",n),r.setAttribute("state",0),r.addEventListener("click",function(){try{if($(this).find(".expand1").get(0)!=null){var e=this.getAttribute("state"),t=this,n=function(){if($(t).parent().find("tbody").get(0).childElementCount===0)return setTimeout(n,1e3);Superlookup(t.getAttribute("checkid"),e),e==0&&t.setAttribute("state",1)};n()}}catch(r){errorHandler("AddEventListener 函数错误！",r)}})),additem=$(courseitem[n]).find("tr[class='active']").get(0),$(additem).find("button[type='button']").length==0&&(addbutton=$(additem).append('<th style="display: none" width="5%"><button class="btn btn-warning" type="button" checkid='+n+' state="0">开始查询</button></th>'),addbutton=addbutton[0],buttonitem=$(additem).find("button[type='button']").get(0),buttonitem.addEventListener("click",function(){try{btnstate=this.getAttribute("state"),Superlookup(this.getAttribute("checkid"),btnstate),btnstate==0&&this.setAttribute("state",1)}catch(e){errorHandler("ButtonaddEventListener 函数错误！",e)}}))}}catch(i){errorHandler("Addbtn 函数错误！",i)}}function Checktime(e,t,n){try{commonBusyTime="",tykBusytime="";var r=$(".outer_xkxx_list");if(!r.length)return;for(var i=0;i<r.length;i++){var s=$($(r[i]).find("h6")[0]).find("a")[0].text;s=s.match(/\(.+?(\)+?)/);if(s==null){swal("课程列表为空？","请查看右侧课程篮子，检查是否有课程！","error");break}s=trimStr(s[0]),s=s.replace("(","").replace(")","");var o;o=$($(r[i]).find("ul")[0]).find("li");for(var u=0;u<o.length;u++){var a;try{a=$($(o[u]).find("table")[0]).find("[class='xxq']")[0].innerHTML,a=trimStr(a)}catch(f){a="0"}var l;try{l=$($(o[u]).find("table")[0]).find("[class='time']")[0].innerHTML,l=trimStr(l),l==="--"&&(l="0")}catch(f){l="0"}enrollinfo[i]={course:s,courseterm:a,coursetime:l},console.log(enrollinfo[i]);if(l!=="0"&&a!=="0"){var c;c=Convertday(l,a),commonBusyTime+=c,s!="tyk"&&s.indexOf("4010")!=0&&(tykBusytime+=c)}}}Superchoose(t,n)}catch(f){errorHandler("Checktime 函数错误！",f)}}function ChangeSortTitie(e){return e.indexOf("▼")!=-1?e.replace("▼","▲"):e.indexOf("▲")!=-1?e.replace("▲","▼"):e+="▼"}function Superchoose(e,t){try{additem=$(courseitem[e]).find("tr[class='active']").get(0),t==0&&(marktitle=$(additem).find("th").get(0),$(marktitle).after('<th nowrap="nowrap" id="score">评分/人数</th>'),titlesort=$(courseitem[e]).find("tr[class='active']").get(0),titlesort=$(titlesort).find("th"),titlesort.get(1)!=null&&(titlesort.get(1).innerText+="▲",titlesort.get(1).onmouseover=Changecursor,titlesort.get(3).innerText+="▲",titlesort.get(3).onmouseover=Changecursor,titlesort.get(4).innerText+="▲",titlesort.get(4).onmouseover=Changecursor,titlesort.get(8).innerText+="▲",titlesort.get(8).onmouseover=Changecursor,titlesort.get(1).addEventListener("click",function(){sortTable(code,2,"float"),titlesort.get(1).innerText=ChangeSortTitie(titlesort.get(1).innerText)}),titlesort.get(3).addEventListener("click",function(){sortTable(code,4,"string"),titlesort.get(3).innerText=ChangeSortTitie(titlesort.get(3).innerText)}),titlesort.get(4).addEventListener("click",function(){sortTable(code,5,"string"),titlesort.get(4).innerText=ChangeSortTitie(titlesort.get(4).innerText)}),titlesort.get(8).addEventListener("click",function(){sortTable(code,9,"int"),titlesort.get(8).innerText=ChangeSortTitie(titlesort.get(8).innerText)})));if(courseitem[e]==null)return;coursecode=courseitem[e].innerText.match(/\(.{1,}\)/);if(coursecode==null)return;coursecode=coursecode[0].replace(/\({0,1}\){0,1}/g,""),idtemp=parseInt(e)+1,code="tbody_"+coursecode+"_"+idtemp,teacheritem=$(courseitem[e]).find("tbody").get(0),teacheritem=$(teacheritem).find("tr");if(teacheritem.length!=0){var n=!1;$("#tykTool")[0].getAttribute("aria-expanded")=="true"?(n=!0,busytime=tykBusytime):busytime=commonBusyTime;for(var r=0;r<teacheritem.length;r++){var i=1,s=1;CourseInfo=teacheritem.get(r),teacher=$(CourseInfo).find("td[class='jsxm']").get(0).innerText,teacher=teacher.split("\n")[0],teacher=teacher.split(" ")[0],t==0&&(scoredigit=$(CourseInfo).find("td[class='jsxm']").get(0),$(scoredigit).after('<td id="scoredigit">暂无</td>')),enroll=$(CourseInfo).find("td[class='an']").get(0),chosen=$(enroll).find("button").get(0).innerHTML,courseterm=$(CourseInfo).find("td[class='xxq']").get(0).innerText,coursetime=$(CourseInfo).find("td[class='sksj']").get(0).innerText,coursespace=$(CourseInfo).find("td[class='rsxx']").get(0).innerText,Timecheck=="enabled"&&(Spare(coursespace)==0&&chosen=="选课"?(enroll.setAttribute("style","visibility:hidden"),s=0):s=1,coursetime=coursetime.replace(/\n/g,"<br>"),Time(coursetime,courseterm,coursecode)==0?(CourseInfo.setAttribute("style","color:#C2C2C2"),i=0):(CourseInfo.setAttribute("style","color:#000000"),i=1),chosen=="退选"?CourseInfo.setAttribute("class","danger"):i==1&&s==1?CourseInfo.setAttribute("class","success"):CourseInfo.setAttribute("class","body_tr"))}getScoresAll()}}catch(o){errorHandler("Superchoose 函数错误！",o)}}function Superlookup(e,t){student=$("#sessionUserKey").val(),Shownotice(Timecheck,Showscore),Checktime(student,e,t)}function trimStr(e){if(typeof e=="undefined")return;return e.replace(/(^\s*)|(\s*$)/g,"")}function convert(e,t){switch(t){case"int":return parseInt(e);case"float":return parseFloat(e);case"date":return new Date(Date.parse(e));default:return e.toString()}}function Sort(){for(var e=0;e<teacheritem.length;e++)for(var t=e;t<teacheritem.length;t++){temp1=teacheritem.get(t),$(temp1).find("td[class='rsxx']").get(0).innerText,temp2=teacheritem.get(e),$(temp2).find("td[class='rsxx']").get(0).innerText;try{var n=convert(temp1,"")}catch(r){n=0}try{var i=convert(temp2,"")}catch(r){i=0}if(n>i){var s=teacheritem.get(t),o=teacheritem.get(t+1);s=temp2,o=temp1}}}function Converttime(e){var t="";return e.indexOf("1")>=0&&e.indexOf("10")<0&&e.indexOf("11")<0&&e.indexOf("12")<0&&e.indexOf("13")<0&&(t+=",01"),e.indexOf("2")>=0&&e.indexOf("12")<0&&(t+=",02"),e.indexOf("3")>=0&&e.indexOf("13")<0&&(t+=",03"),e.indexOf("4")>=0&&(t+=",04"),e.indexOf("5")>=0&&(t+=",05"),e.indexOf("6")>=0&&(t+=",06"),e.indexOf("7")>=0&&(t+=",07"),e.indexOf("8")>=0&&(t+=",08"),e.indexOf("9")>=0&&(t+=",09"),e.indexOf("10")>=0&&(t+=",10"),e.indexOf("11")>=0&&(t+=",11"),e.indexOf("12")>=0&&(t+=",12"),e.indexOf("13")>=0&&(t+=",13"),t}function Convertterm(e){var t="";return e.indexOf("秋")>=0&&(t+=",01"),e.indexOf("冬")>=0&&(t+=",02"),e.indexOf("春")>=0&&(t+=",03"),e.indexOf("夏")>=0&&(t+=",04"),t}function Convertweekly(e){var t="";return e.indexOf("双周")>=0?t+=",d":e.indexOf("单周")>=0?t+=",s":t+=",d,s",t}function Convertday(e,t){e=e.split("<br>");var n="",r="";termcache=Convertterm(t).split(",");for(var i=1;i<termcache.length;i++)for(var s=0;s<e.length;s++){weekcache=Convertweekly(e[s]).split(",");if(e[s].indexOf("周一")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"1x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周二")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"2x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周三")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"3x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周四")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"4x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周五")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"5x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周六")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"6x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周日")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"7x"+o[u]+termcache[i]+weekcache[a]+","}}return n}function AddSort(e){tdstitle=trs[0].getElementsByTagName("td"),chrome.runtime.sendMessage({key:"Showinfo"},function(e){e==1&&swal("教师排序模块已激活","现在你可以点击表头的相应文字对所有教师进行排序，同时点击教师评分和均绩可进入学习帝查看评论详情~","info")}),e==1&&(tdstitle[1].onmouseover=Changecursor,tdstitle[1].onclick=function(){Sort(1,"float")}),tdstitle[3+e].onmouseover=Changecursor,tdstitle[3+e].onclick=function(){Sort(3+e,"string")},tdstitle[4+e].onmouseover=Changecursor,tdstitle[4+e].onclick=function(){Sort(4+e,"string")},tdstitle[6+e].onmouseover=Changecursor,tdstitle[6+e].onclick=function(){Sort(6+e,"int")}}function Showprogress(){Timecheck=="enabled"&&Showscore=="disabled"?(chrome.runtime.sendMessage({cmd:"finish"},function(e){}),AddSort(0)):Showscore=="enabled"&&chrome.runtime.sendMessage({cmd:"finish"},function(e){})}function Shownotice(e,t){try{chrome.runtime.sendMessage({cmd:"clear"},function(e){}),t=="enabled"?(chrome.runtime.sendMessage({cmd:"create1"},function(e){}),Showprogress()):e=="enabled"&&(chrome.runtime.sendMessage({cmd:"create1"},function(e){}),Showprogress())}catch(n){}}function Time(e,t,n){try{var r=0,i=Convertday(e,t);i=i.split(",");for(j=0;j<i.length-1;j++)if(busytime.indexOf(i[j])>=0){r=0;break}j>=i.length-1&&(r=1);for(x=0;x<enrollinfo.length;x++)n==enrollinfo[x].course&&e==enrollinfo[x].coursetime&&t==enrollinfo[x].courseterm&&(r=1);return r}catch(s){errorHandler("时间冲突判断模块错误！",s)}}function Spare(e){try{return e=e.split("/")[0],e<=0?0:1}catch(t){errorHandler("课程余量判断模块错误！",t)}}function getScoresAll(){var e=[];$.each(teacheritem,function(t,n){var r=$(teacheritem.get(t)).find("td[class='jsxm']").get(0);r!=null&&(r=r.innerText,r=r.split("\n")[0],r=r.split(" ")[0],e.push(r))}),$.ajax({type:"POST",dataType:"json",data:{student:student,teacher:JSON.stringify(e)},url:"https://enroll.zjuqsc.com/user/quickSearch",error:function(){swal("服务器响应超时","貌似最近访问的人太多了，服务器忙不过来啦~","error")},success:function(e){if(e.success===0){var t=e.data;$.each(teacheritem,function(e,n){var r,i=$(teacheritem.get(e)).find("td[class='jsxm']").get(0).innerText;i=i.split("\n")[0],i=i.split(" ")[0];for(var s=0;s<t.length;s++)if(i===t[s].Name)break;if(s>=t.length)score="0.00",scorenum=0;else{var o=t[s];try{var u=o.tea_id;score=o.Score,score=="N/A"&&(score="0.00"),scorenum=o.AssessNum}catch(a){score="0.00"}score==null&&(score="0.00"),scorenum==null&&(scorenum=0)}r=$(teacheritem.get(e)).find("td[id='scoredigit']").get(0),r.innerHTML=score+"/"+scorenum,r.onmouseover=Changecursor,r.onclick=function(){window.open("https://chalaoshi.cn/teacher/"+u+"/")},score>8.6?r.style.color="red":r.style.color=""})}}})}function getScores(e,t){try{var n;if(e>=teacheritem.length)return;teacher=$(teacheritem.get(e)).find("td[class='jsxm']").get(0).innerText,teacher=teacher.split("\n")[0],teacher=teacher.split(" ")[0],teacher=encodeURIComponent(teacher),$.ajax({type:"GET",dataType:"json",url:"https://enroll.zjuqsc.com/user/search?name="+teacher,error:function(){swal("服务器响应超时","貌似最近访问的人太多了，服务器忙不过来啦~","error")},complete:function(t,r){try{msgdata=t.responseJSON,n=msgdata.ID,score=msgdata.Score,scorenum=msgdata.AssessNum}catch(i){score=0}scoredigit=$(teacheritem.get(e)).find("td[id='scoredigit']").get(0),scoredigit.innerHTML=score+"/"+scorenum,scoredigit.onmouseover=Changecursor,scoredigit.onclick=function(){window.open("https://chalaoshi.cn/teacher/"+n+"/")},score>8.6?scoredigit.style.color="red":scoredigit.style.color="",e++,getScores(e)}})}catch(r){errorHandler("教师评分及均绩查询模块错误！",r)}}function Changecursor(){this.style.cursor="pointer"}function GetPermit(e,t){try{e=e.match(/richContent3'>\n.{0,}\n<\/div>/),e=e[0].match(/<p>\d{1,}<\/p>/g);for(var n=0;n<e.length;n++){target=e[n].match(/\d{1,}/),target=target[0];if(t==target)return 1}return 0}catch(r){errorHandler("身份验证模块错误！",r)}}function infoGather(e){$.ajax({url:"https://enroll.zjuqsc.com/user/errfeedback",timeout:3e3,type:"POST",dataType:"json",data:{errname:"jwbinfo",errmessage:"jwbinfo",errlog:e,userAgent:navigator.userAgent,stuid:student,version:nowver},cache:!1})}function errorHandler(e,t){console.log(t),swal(e,"呜呜……/(ㄒoㄒ)/~选课助手崩溃啦，崩溃日志已经被上传到服务器，请等待作者回应。您还可以联系作者详细描述错误情形以帮助改进插件~\n\n错误信息：\n"+t,"error"),$.ajax({url:"https://enroll.zjuqsc.com/user/errfeedback",timeout:3e3,type:"POST",dataType:"json",data:{errname:t.name,errmessage:t.message,errlog:t.stack,userAgent:navigator.userAgent,stuid:student,version:nowver},cache:!1}),infoGather(document.getElementsByTagName("html")[0].innerHTML)}var student,busytime="",commonBusyTime="",tykBusytime="",enrollinfo=[],title,courseitem,teacheritem,sort=0,Showscore,Timecheck,nowver;$(document).ready(function(){try{student=$("#sessionUserKey").val(),chrome.runtime.sendMessage({cmd:"Stu",data:student},function(e){})}catch(e){errorHandler("获取学号信息错误！",e)}chrome.runtime.sendMessage({key:"update"},function(e){console.log(e);try{upenabledvalue=e.upenabled}catch(t){upenabledvalue=0}nowver=e.nowver,upenabledvalue==1&&swal({title:"检测到主程序更新",text:"选课助手要更新啦~点击确定下载~记得安装哦！！\n\n当前版本："+nowver+"\n\n最新版本："+e.latestver+"\n\n为保证用户体验，插件需要更新才能使用哦~",type:"info",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"开始升级",cancelButtonText:"取消升级",closeOnCancel:!1},function(t){t?window.open(e.updateurl):swal({title:"取消升级",text:"为保证用户体验，插件需升级到最新版本才可使用，确认要取消吗？点击取消将打开升级页面",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"确定",cancelButtonText:"取消"},function(t){t||window.open(e.updateurl)})}),chrome.runtime.sendMessage({key:"Genuine"},function(t){t==0?swal("主程序错误！","检测到插件被二次打包！\n为保护作者版权，请重新下载官方版本！\n下载地址："+e.updateurl,"error"):chrome.runtime.sendMessage({key:"Getsettings"},function(e){e=e.split(","),Showscore=e[0],Timecheck=e[2],NewVer=e[4],permit=e[3],Main()})})})});