function trimStr(e){return e.replace(/(^\s*)|(\s*$)/g,"")}function Converttime(e){var t="";return e.indexOf("1")>=0&&e.indexOf("10")<0&&e.indexOf("11")<0&&e.indexOf("12")<0&&e.indexOf("13")<0&&(t+=",01"),e.indexOf("2")>=0&&e.indexOf("12")<0&&(t+=",02"),e.indexOf("3")>=0&&e.indexOf("13")<0&&(t+=",03"),e.indexOf("4")>=0&&(t+=",04"),e.indexOf("5")>=0&&(t+=",05"),e.indexOf("6")>=0&&(t+=",06"),e.indexOf("7")>=0&&(t+=",07"),e.indexOf("8")>=0&&(t+=",08"),e.indexOf("9")>=0&&(t+=",09"),e.indexOf("10")>=0&&(t+=",10"),e.indexOf("11")>=0&&(t+=",11"),e.indexOf("12")>=0&&(t+=",12"),e.indexOf("13")>=0&&(t+=",13"),t}function Convertterm(e){var t="";return e.indexOf("秋")>=0&&(t+=",01"),e.indexOf("冬")>=0&&(t+=",02"),e.indexOf("春")>=0&&(t+=",03"),e.indexOf("夏")>=0&&(t+=",04"),t}function Convertweekly(e){var t="";return e.indexOf("双周")>=0?t+=",d":e.indexOf("单周")>=0?t+=",s":t+=",d,s",t}function GetSubject(){subject=document.getElementById("Label_jbxx").innerText,subject=subject.match(/课程名称：.*学分/),subject=subject[0].substr(5),subject=trimStr(subject.substr(0,subject.length-2))}function Convertday(e,t){e=e.split("<br>");var n="",r="";termcache=Convertterm(t).split(",");for(var i=1;i<termcache.length;i++)for(var s=0;s<e.length;s++){weekcache=Convertweekly(e[s]).split(",");if(e[s].indexOf("周一")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"1x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周二")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"2x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周三")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"3x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周四")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"4x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周五")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"5x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周六")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"6x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周日")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"7x"+o[u]+termcache[i]+weekcache[a]+","}}return n}function Checktime(e){try{NProgress.inc(),data=$.ajax({type:"GET",async:!1,timeout:5e3,url:adjustinner+"/xskbcx.aspx?xh="+e,error:function(e,t,n){swal("获取课表错误！","呜呜……选课助手发现教务网好像出了什么问题~主人快检查下能否正常进入教务网哦~","error")}}).responseText,NProgress.done(),data=data.match(/<A href='#' onclick="window.open\('.{1,}','kcb','toolbar=0,location=0,directories=0,status=0,menubar=0,scrollbars=1,resizable=1'\)">(<i><font color=red>){0,1}.{1,}(<\/font><\/i>){0,1}<\/a><\/td><td>.{1,}<\/td><td>.{1,}<\/td><td>.{1,}<\/td><td>.{1,}<\/td><td>.{1,}<\/td>/ig);for(var t=0;t<data.length;t++){var n=data[t].match(/<A href='#' onclick="window.open\('.{1,}','kcb','toolbar=0,location=0,directories=0,status=0,menubar=0,scrollbars=1,resizable=1'\)">(<i><font color=red>){0,1}[0-9A-Z]{8}(<\/font><\/i>){0,1}<\/A>/g);n=n[0].match(/[0-9A-Z]{8}/),n=n[0];try{var r=data[t].match(/<td>[\u4e00-\u9fa5]{1,2}<\/td>/);r=r[0].match(/[\u4e00-\u9fa5]{1,2}/),r=r[0]}catch(i){r="0"}try{var s=data[t].match(/周[\u4e00-\u9fa5]{1}第.{1,}节.{0,4}<\/td>/g);s=s[0],s=s.replace("</td>","")}catch(i){s="0"}courseinfo[t]={course:n,courseterm:r,coursetime:s},console.log(courseinfo[t]),s!="0"&&r!="0"&&(busytime+=Convertday(s,r))}}catch(i){errorHandler("上课时间获取模块错误！",i)}}function Sort(e,t){sortTable("jsgrid",e,t),sort++;var n=tdstitle[e].innerHTML;n=n.replace("▼",""),n=n.replace("▲",""),sort%2==0?tdstitle[e].innerHTML=n+"▲":tdstitle[e].innerHTML=n+"▼"}function AddSort(e){tdstitle=trs[0].getElementsByTagName("td"),chrome.extension.sendRequest({key:"Showinfo"},function(e){e==1&&swal("教师排序模块已激活","现在你可以点击表头的相应文字对所有教师进行排序，同时点击教师评分和均绩可进入学习帝查看评论详情~","info")}),e==1&&(tdstitle[1].onmouseover=Changecursor,tdstitle[1].onclick=function(){Sort(1,"float")}),tdstitle[3+e].onmouseover=Changecursor,tdstitle[3+e].onclick=function(){Sort(3+e,"string")},tdstitle[4+e].onmouseover=Changecursor,tdstitle[4+e].onclick=function(){Sort(4+e,"string")},tdstitle[6+e].onmouseover=Changecursor,tdstitle[6+e].onclick=function(){Sort(6+e,"int")}}function Showprogress(e){if(Showscore=="enabled"){NProgress.set(e/100);var t=document.getElementsByTagName("title")[0];if(!t){var t=document.createElement("title");t.innerHTML="萌萌哒选课助手正在为你努力地工作哦……o(〃'▽'〃)o已完成："+Math.round(e)+"%",document.getElementsByTagName("head")[0].appendChild(t)}else t.innerHTML="萌萌哒选课助手正在为你努力地工作哦……o(〃'▽'〃)o已完成："+Math.round(e)+"%";e==100&&(t.innerHTML="选课助手已经完成主人交给的任务了呢~(^o^)/！现在主人可以很方便地选课啦~",chrome.extension.sendMessage({cmd:"finish"},function(e){}),NProgress.done(),window.clearInterval(id))}else if(Timecheck=="enabled"&&Showscore=="disabled"){chrome.extension.sendMessage({cmd:"finish"},function(e){}),AddSort(0);var t=document.getElementsByTagName("title")[0];if(!t){var t=document.createElement("title");t.innerHTML="选课助手已经完成主人交给的任务了呢~(^o^)/！现在主人可以很方便地选课啦~",document.getElementsByTagName("head")[0].appendChild(t)}else t.innerHTML="选课助手已经完成主人交给的任务了呢~(^o^)/！现在主人可以很方便地选课啦~";NProgress.done()}}function Shownotice(e,t,n){n=="enabled"?(chrome.extension.sendMessage({cmd:"create1"},function(e){}),id=window.setInterval("Showprogress(progress)",1e3)):e=="enabled"&&(chrome.extension.sendMessage({cmd:"create1"},function(e){}),Showprogress(progress))}function Time(){try{for(var e=1;e<trs.length;e++){var t=trs[e].getElementsByTagName("td"),n=t[2].innerHTML,r=t[3].innerHTML,i=Convertday(r,n);i=i.split(",");for(j=0;j<i.length-1;j++){if(busytime.indexOf(i[j])>=0){trs[e].style.color="#C2C2C2";break}trs[e].style.color="black"}var s=document.getElementById("Label_jbxx").innerText;s=s.match(/课程代码：.{8}/),s=s[0].match(/[0-9A-Z]{8}/),s=s[0];for(j=0;j<courseinfo.length;j++)s==courseinfo[j].course&&r==courseinfo[j].coursetime&&n==courseinfo[j].courseterm&&(trs[e].style.color="black");trs[e].style.color=="rgb(194, 194, 194)"&&(trs[e].onmouseout=function(){this.style.color="#C2C2C2"},trs[e].onmouseover=function(){this.style.color="#8B8B8B"})}}catch(o){errorHandler("时间冲突判断模块错误！",o)}}function Spare(){try{for(var e=1;e<trs.length;e++){var t=trs[e].getElementsByTagName("td"),n=t[6].innerHTML;n=n.match(/[-\d{1,}\/]/),n=n[0].match(/\d{1,}/);var r=t[11].getElementsByTagName("input");n<=0&&r[0].checked==0&&(r[0].setAttribute("disabled","disabled"),r[0].style.display="none")}}catch(i){errorHandler("课程余量判断模块错误！",i)}}function Adjustlineheight(){for(var e=1;e<trs.length;e++){var t=trs[e].getElementsByTagName("td"),n=document.createElement("td");n.innerHTML='<div style="height:8px"></div>',t[0].appendChild(n)}}function Highlight(){for(var e=1;e<trs.length;e++){var t=trs[e].getElementsByTagName("td"),n=t[11].getElementsByTagName("input");n[0].style.display!="none"&&trs[e].style.color=="black"&&(trs[e].style.backgroundColor="#CBFFBF",trs[e].onmouseout=function(){this.style.backgroundColor="#CBFFBF"},trs[e].onmouseover=function(){this.style.backgroundColor="#ACFF9B"}),n[0].checked==1&&(trs[e].style.backgroundColor="#FFDBCC",trs[e].onmouseout=function(){this.style.backgroundColor="#FFDBCC"},trs[e].onmouseover=function(){this.style.backgroundColor="#FFC5AC"})}}function Changecursor(){this.style.cursor="pointer"}function ChangeTitle(){var e=trs[0].insertCell(1);e.style.width="6%",e.innerHTML="评分/人数";for(var t=1;t<=trs.length-1;t++)e=trs[t].insertCell(1),e.innerHTML="";for(var t=0;t<=trs.length-1;t++){var n=trs[t].getElementsByTagName("td");trs[t].removeChild(n[8])}}function getScores(e){var t,n,r;try{if(e>trs.length-1){AddSort(1),progress=100;return}progress=e/(trs.length-1)*100;var i=trs[e].innerHTML;i=i.match(/target="_blank">.{1,}<\/a>/),i=i[0].match(/>.{1,}</),i=i[0].match(/[\u4e00-\u9fa5a-zA-Z\s]{1,}/),i=encodeURIComponent(i),$.ajax({type:"GET",dataType:"json",url:"https://enrollment.zju-lab.cn/user/search?name="+i,error:function(){swal("服务器响应超时","貌似最近访问的人太多了，服务器忙不过来啦~","error")},complete:function(t,i){var s=trs[e].getElementsByTagName("td"),o=document.createElement("td"),u=document.createElement("td");try{msgdata=t.responseJSON,r=msgdata.ID,score=msgdata.Score,scorenum=msgdata.AssessNum}catch(a){score=0}score==null&&(score=0),scorenum==null&&(scorenum=0),score>8.6?(o.innerHTML='<div style="height:8px"></div>',s[1].innerHTML=score+" / "+scorenum,s[1].style.color="red",s[1].onclick=function(){window.open("http://chalaoshi.cn/teacher/"+r+"/")},s[1].onmouseover=Changecursor,s[0].appendChild(o)):(o.innerHTML='<div style="height:8px"></div>',s[1].innerHTML=score+" / "+scorenum,s[1].style.color="",s[1].onclick=function(){window.open("http://chalaoshi.cn/teacher/"+r+"/")},s[1].onmouseover=Changecursor,s[0].appendChild(o)),e++,getScores(e)}})}catch(s){errorHandler("教师评分及均绩查询模块错误！",s)}}function Main(){try{if(Timecheck!="disabled"||Showscore!="disabled")permit==0&&Showscore=="enabled"?(Showscore="disabled",chrome.extension.sendMessage({cmd:"scoredisabled"},function(e){}),chrome.extension.sendMessage({cmd:"GPAdisabled"},function(e){}),swal("插件功能受限！","由于插件中的教师查询模块涉及@ZJU学习帝的版权问题，只面向小范围开放测试\n插件此项功能即将自动关闭！！可点击右上角图标重新启用\n酷爱来这里申请内测权限吧~:https://enrollment.zju-lab.cn/apply/","warning")):Shownotice(Timecheck,Sparecheck,Showscore);Timecheck=="enabled"&&(Time(),Spare()),Highlight(),Showscore=="enabled"?(ChangeTitle(),getScores(1)):Adjustlineheight()}catch(e){errorHandler("Main函数错误！",e)}}function errorHandler(e,t){$.ajax({url:"https://enrollment.zju-lab.cn/user/errfeedback",timeout:3e3,type:"POST",dataType:"json",data:{errname:t.name,errmessage:t.message,errlog:t.stack,userAgent:navigator.userAgent,stuid:student,version:nowver},cache:!1}),console.log(t),swal(e,"呜呜……/(ㄒoㄒ)/~选课助手崩溃啦，崩溃日志已经被上传到服务器，请等待作者回应。您还可以联系作者详细描述错误情形以帮助改进插件~\n\n错误信息：\n"+t,"error")}var item=document.getElementById("jsgrid"),tbody=item.getElementsByTagName("tbody")[0],trs=tbody.getElementsByTagName("tr"),xmlhttp,courseinfo=new Array,busytime="",progress=0,id,Showscore,ShowGPA,Timecheck,Sparecheck,student,permit=0,subject,Debugmode=1,sort=0,tdstitle,adjustinner,teaEncodes=new Array,teas=new Array,teainfos=new Array;adjustinner=window.document.location.origin;try{student=document.getElementById("Label_jbxx").innerText,student=student.match(/学号：\d{1,}/),student=student[0].match(/\d{1,}/),student=student[0],chrome.extension.sendMessage({cmd:"Stu",data:student},function(e){})}catch(err){errorHandler("获取学号信息错误！",err)}chrome.extension.sendRequest({key:"update"},function(e){console.log(e);try{upenabledvalue=e.upenabled}catch(t){upenabledvalue=0}upenabledvalue==1&&swal({title:"检测到主程序更新",text:"选课助手要更新啦~点击确定下载~记得安装哦！！\n\n当前版本："+e.nowver+"\n\n最新版本："+e.latestver+"\n\n为保证用户体验，插件需要更新才能使用哦~",type:"info",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"开始升级",cancelButtonText:"取消升级",closeOnCancel:!1},function(t){t?window.open(e.updateurl):swal({title:"取消升级",text:"为保证用户体验，插件需升级到最新版本才可使用，确认要取消吗？点击取消将打开升级页面",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"确定",cancelButtonText:"取消"},function(t){t||window.open(e.updateurl)})}),chrome.extension.sendRequest({key:"Genuine"},function(t){if(t==0)swal("主程序错误！","检测到插件被二次打包！\n为保护作者版权，请重新下载官方版本！\n下载地址："+e.updateurl,"error");else try{GetSubject(),chrome.extension.sendRequest({key:"Getsettings"},function(e){e=e.split(","),Showscore=e[0],ShowGPA=e[1],Timecheck=e[2],permit=1,Timecheck=="enabled"&&Checktime(student),Showscore=="enabled"||ShowGPA=="enabled"?permit==1?(chrome.extension.sendMessage({cmd:"clear"},function(e){}),Main()):permit==0&&(Showscore="disabled",ShowGPA="disabled",chrome.extension.sendMessage({cmd:"clear"},function(e){}),Main()):(NProgress.done(),chrome.extension.sendMessage({cmd:"clear"},function(e){}),Main())})}catch(n){errorHandler("主程序错误！",n)}})});