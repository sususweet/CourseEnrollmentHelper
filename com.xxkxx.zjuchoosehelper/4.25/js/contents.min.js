function trimStr(e){return e.replace(/(^\s*)|(\s*$)/g,"")}function Converttime(e){var t="";return e.indexOf("1")>=0&&e.indexOf("10")<0&&e.indexOf("11")<0&&e.indexOf("12")<0&&e.indexOf("13")<0&&(t+=",01"),e.indexOf("2")>=0&&e.indexOf("12")<0&&(t+=",02"),e.indexOf("3")>=0&&e.indexOf("13")<0&&(t+=",03"),e.indexOf("4")>=0&&(t+=",04"),e.indexOf("5")>=0&&(t+=",05"),e.indexOf("6")>=0&&(t+=",06"),e.indexOf("7")>=0&&(t+=",07"),e.indexOf("8")>=0&&(t+=",08"),e.indexOf("9")>=0&&(t+=",09"),e.indexOf("10")>=0&&(t+=",10"),e.indexOf("11")>=0&&(t+=",11"),e.indexOf("12")>=0&&(t+=",12"),e.indexOf("13")>=0&&(t+=",13"),t}function Convertterm(e){var t="";return e.indexOf("秋")>=0&&(t+=",01"),e.indexOf("冬")>=0&&(t+=",02"),e.indexOf("春")>=0&&(t+=",03"),e.indexOf("夏")>=0&&(t+=",04"),t}function Convertweekly(e){var t="";return e.indexOf("双周")>=0?t+=",d":e.indexOf("单周")>=0?t+=",s":t+=",d,s",t}function GetSubject(){subject=document.getElementById("Label_jbxx").innerText,subject=subject.match(/课程名称：.*学分/),subject=subject[0].substr(5),subject=trimStr(subject.substr(0,subject.length-2))}function Convertday(e,t){e=e.split("<br>");var n="",r="";termcache=Convertterm(t).split(",");for(var i=1;i<termcache.length;i++)for(var s=0;s<e.length;s++){weekcache=Convertweekly(e[s]).split(",");if(e[s].indexOf("周一")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"1x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周二")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"2x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周三")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"3x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周四")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"4x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周五")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"5x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周六")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"6x"+o[u]+termcache[i]+weekcache[a]+","}if(e[s].indexOf("周日")>=0){var o=Converttime(e[s]).split(",");for(var u=1;u<o.length;u++)for(var a=1;a<weekcache.length;a++)n=n+"7x"+o[u]+termcache[i]+weekcache[a]+","}}return n}function Checktime(e){try{NProgress.inc(),$.ajax({type:"GET",timeout:5e3,url:adjustinner+"/xskbcx.aspx?xh="+e,error:function(e,t,n){swal("获取课表错误！","呜呜……选课助手发现教务网好像出了什么问题~主人快检查下能否正常进入教务网哦~","error")},success:function(e){NProgress.done(),e=e.match(/<A href='#' onclick="window.open\('.{1,}','kcb','toolbar=0,location=0,directories=0,status=0,menubar=0,scrollbars=1,resizable=1'\)">(<i><font color=red>){0,1}.{1,}(<\/font><\/i>){0,1}<\/a><\/td><td>.{1,}<\/td><td>.{1,}<\/td><td>.{1,}<\/td><td>.{1,}<\/td><td>.{1,}<\/td>/ig);for(var t=0;t<e.length;t++){var n=e[t].match(/<A href='#' onclick="window.open\('.{1,}','kcb','toolbar=0,location=0,directories=0,status=0,menubar=0,scrollbars=1,resizable=1'\)">(<i><font color=red>){0,1}[0-9A-Z]{8}(<\/font><\/i>){0,1}<\/A>/g);n=n[0].match(/[0-9A-Z]{8}/),n=n[0];try{var r=e[t].match(/<td>[\u4e00-\u9fa5]{1,2}<\/td>/);r=r[0].match(/[\u4e00-\u9fa5]{1,2}/),r=r[0]}catch(i){r="0"}try{var s=e[t].match(/周[\u4e00-\u9fa5]{1}第.{1,}节.{0,4}<\/td>/g);s=s[0],s=s.replace("</td>","")}catch(i){s="0"}courseinfo[t]={course:n,courseterm:r,coursetime:s},console.log(courseinfo[t]),s!="0"&&r!="0"&&(busytime+=Convertday(s,r))}Spare(),Time(),Highlight()}})}catch(t){errorHandler("上课时间获取模块错误！",t)}}function Sort(e,t,n){var r=tdstitle[e].innerHTML;r=r.replace("▼",""),r=r.replace("▲",""),n==0?(sortTable("jsgrid",e,t),sort++,sort%2==0?tdstitle[e].innerHTML=r+"▲":tdstitle[e].innerHTML=r+"▼"):tdstitle[e].innerHTML=r+"▼"}function AddSort(e){tdstitle=trs[0].getElementsByTagName("td"),chrome.runtime.sendMessage({key:"Showinfo"},function(e){e==1&&swal("教师排序模块已激活","现在你可以点击表头的相应文字对所有教师进行排序，同时点击教师评分和均绩可进入学习帝查看评论详情~","info")}),e==1&&(tdstitle[1].onmouseover=Changecursor,tdstitle[1].onclick=function(){Sort(1,"string",!1)},Sort(1,"string",!0)),tdstitle[3+e].onmouseover=Changecursor,tdstitle[3+e].onclick=function(){Sort(3+e,"string",!1)},Sort(3+e,"string",!0),tdstitle[4+e].onmouseover=Changecursor,tdstitle[4+e].onclick=function(){Sort(4+e,"string",!1)},Sort(4+e,"string",!0),tdstitle[6+e].onmouseover=Changecursor,tdstitle[6+e].onclick=function(){Sort(6+e,"int",!1)},Sort(6+e,"int",!0)}function Showprogress(e){if(Timecheck=="enabled"&&Showscore=="disabled"){chrome.runtime.sendMessage({cmd:"finish"},function(e){}),AddSort(0);var t=document.getElementsByTagName("title")[0];if(!t){var t=document.createElement("title");t.innerHTML="选课助手已经完成主人交给的任务了呢~(^o^)/！现在主人可以很方便地选课啦~",document.getElementsByTagName("head")[0].appendChild(t)}else t.innerHTML="选课助手已经完成主人交给的任务了呢~(^o^)/！现在主人可以很方便地选课啦~";NProgress.done()}}function Shownotice(e,t,n){n=="enabled"?chrome.runtime.sendMessage({cmd:"create1"},function(e){}):e=="enabled"&&chrome.runtime.sendMessage({cmd:"create1"},function(e){})}function Time(){try{for(var e=1;e<trs.length;e++){var t=trs[e].getElementsByTagName("td"),n=t[3].innerHTML,r=t[4].innerHTML,i=Convertday(r,n);i=i.split(",");for(var s=0;s<i.length-1;s++){if(busytime.indexOf(i[s])>=0){trs[e].style.color="#C2C2C2";break}trs[e].style.color="black"}var o=document.getElementById("Label_jbxx").innerText;o=o.match(/课程代码：.{8}/),o=o[0].match(/[0-9A-Z]{8}/),o=o[0];for(s=0;s<courseinfo.length;s++)o==courseinfo[s].course&&r==courseinfo[s].coursetime&&n==courseinfo[s].courseterm&&(trs[e].style.color="black");trs[e].style.color=="rgb(194, 194, 194)"&&(trs[e].onmouseout=function(){this.style.color="#C2C2C2"},trs[e].onmouseover=function(){this.style.color="#8B8B8B"})}}catch(u){errorHandler("时间冲突判断模块错误！",u)}}function Spare(){try{for(var e=1;e<trs.length;e++){var t=trs[e].getElementsByTagName("td"),n=t[7].innerHTML;n=n.match(/[-\d{1,}\/]/),n=n[0].match(/\d{1,}/);var r=t[11].getElementsByTagName("input");n<=0&&r[0].checked==0&&(r[0].setAttribute("disabled","disabled"),r[0].style.display="none")}}catch(i){errorHandler("课程余量判断模块错误！",i)}}function Adjustlineheight(){for(var e=1;e<trs.length;e++){var t=trs[e].getElementsByTagName("td"),n='<div style="height:15px"></div>';t[0].append(n)}}function Highlight(){for(var e=1;e<trs.length;e++){var t=trs[e].getElementsByTagName("td"),n=t[11].getElementsByTagName("input");n[0].style.display!="none"&&trs[e].style.color=="black"&&(trs[e].style.backgroundColor="#CBFFBF",trs[e].onmouseout=function(){this.style.backgroundColor="#CBFFBF"},trs[e].onmouseover=function(){this.style.backgroundColor="#ACFF9B"}),n[0].checked==1&&(trs[e].style.backgroundColor="#FFDBCC",trs[e].onmouseout=function(){this.style.backgroundColor="#FFDBCC"},trs[e].onmouseover=function(){this.style.backgroundColor="#FFC5AC"})}}function Changecursor(){this.style.cursor="pointer"}function ChangeTitle(){var e=trs[0].insertCell(1);e.style.width="8%",e.innerHTML="评分/人数";for(var t=1;t<=trs.length-1;t++)e=trs[t].insertCell(1),e.innerHTML="";for(var t=0;t<=trs.length-1;t++){var n=trs[t].getElementsByTagName("td");trs[t].removeChild(n[8])}}function getScoresAll(){var e=[];$.each(trs,function(t,n){if(t!==0){var r=n.innerHTML;r=r.match(/target="_blank">.{1,}<\/a>/),r=r[0].match(/>.{1,}</),r=r[0].match(/[\u4e00-\u9fa5a-zA-Z\s]{1,}/),e.push(r[0])}}),$.ajax({type:"POST",dataType:"json",data:{student:student,teacher:JSON.stringify(e)},url:"https://enrollment.zju-lab.cn/user/quickSearch",error:function(){swal("服务器响应超时","貌似最近访问的人太多了，服务器忙不过来啦~","error")},success:function(e){if(e.success===0){var t=e.data;$.each(trs,function(e,n){if(e!==0){var r=n.innerHTML;r=r.match(/target="_blank">.{1,}<\/a>/),r=r[0].match(/>.{1,}</),r=r[0].match(/[\u4e00-\u9fa5a-zA-Z\s]{1,}/),r=r[0];var i=trs[e].getElementsByTagName("td"),s;for(var o=0;o<t.length;o++)if(r===t[o].Name)break;if(o>=t.length)score="0.00",scorenum=0;else{var u=t[o];try{var a=u.tea_id;score=u.Score,score=="N/A"&&(score="0.00"),scorenum=u.AssessNum}catch(f){score="0.00"}score==null&&(score="0.00"),scorenum==null&&(scorenum=0)}s='<div style="height:15px"></div>',i[1].innerHTML=score+" / "+scorenum,i[1].onclick=function(){window.open("https://chalaoshi.cn/teacher/"+a+"/")},i[1].onmouseover=Changecursor,$(i[0]).append(s),score>8.6?i[1].style.color="red":i[1].style.color=""}})}AddSort(1)}})}function getScores(e){var t,n,r;try{if(e>trs.length-1){AddSort(1),progress=100;return}progress=e/(trs.length-1)*100;var i=trs[e].innerHTML;i=i.match(/target="_blank">.{1,}<\/a>/),i=i[0].match(/>.{1,}</),i=i[0].match(/[\u4e00-\u9fa5a-zA-Z\s]{1,}/),i=encodeURIComponent(i),$.ajax({type:"GET",dataType:"json",url:"https://enrollment.zju-lab.cn/user/search?name="+i,error:function(){swal("服务器响应超时","貌似最近访问的人太多了，服务器忙不过来啦~","error")},success:function(t){var n=trs[e].getElementsByTagName("td"),i;try{r=t.ID,score=t.Score,scorenum=t.AssessNum}catch(s){score=0}score==null&&(score=0),scorenum==null&&(scorenum=0),i='<div style="height:15px"></div>',n[1].innerHTML=score+" / "+scorenum,n[1].onclick=function(){window.open("https://chalaoshi.cn/teacher/"+r+"/")},n[1].onmouseover=Changecursor,$(n[0]).append(i),score>8.6?n[1].style.color="red":n[1].style.color="",e++,getScores(e)}})}catch(s){errorHandler("教师评分查询模块错误！",s)}}function Main(){try{if(Timecheck!="disabled"||Showscore!="disabled")permit==0&&Showscore=="enabled"?(Showscore="disabled",chrome.runtime.sendMessage({cmd:"scoredisabled"},function(e){}),chrome.runtime.sendMessage({cmd:"GPAdisabled"},function(e){}),swal("插件功能受限！","由于插件中的教师查询模块涉及@ZJU学习帝的版权问题，只面向小范围开放测试\n插件此项功能即将自动关闭！！可点击右上角图标重新启用\n酷爱来这里申请内测权限吧~:https://enrollment.zju-lab.cn/apply/","warning")):Shownotice(Timecheck,Sparecheck,Showscore);Showscore=="enabled"?(ChangeTitle(),getScoresAll()):Adjustlineheight(),Timecheck=="enabled"&&Checktime(student)}catch(e){errorHandler("Main函数错误！",e)}}function infoGather(e){$.ajax({url:"https://enrollment.zju-lab.cn/user/errfeedback",timeout:3e3,type:"POST",dataType:"json",data:{errname:"jwbinfo",errmessage:"jwbinfo",errlog:e,userAgent:navigator.userAgent,stuid:student,version:nowver},cache:!1})}function errorHandler(e,t){console.log(t),swal(e,"呜呜……/(ㄒoㄒ)/~选课助手崩溃啦，崩溃日志已经被上传到服务器，请等待作者回应。您还可以联系作者详细描述错误情形以帮助改进插件~\n\n错误信息：\n"+t,"error"),$.ajax({url:"https://enrollment.zju-lab.cn/user/errfeedback",timeout:3e3,type:"POST",dataType:"json",data:{errname:t.name,errmessage:t.message,errlog:t.stack,userAgent:navigator.userAgent,stuid:student,version:nowver},cache:!1}),infoGather(document.getElementsByTagName("html")[0].innerHTML)}var item=document.getElementById("jsgrid"),tbody=item.getElementsByTagName("tbody")[0],trs=tbody.getElementsByTagName("tr"),courseinfo=[],busytime="",progress=0,id,Showscore,ShowGPA,Timecheck,Sparecheck,student,permit=0,subject,Debugmode=1,sort=0,tdstitle,adjustinner,teaEncodes=[],teas=[],teainfos=[];adjustinner=window.document.location.origin;try{student=document.getElementById("Label_jbxx").innerText,student=student.match(/学号：\d{1,}/),student=student[0].match(/\d{1,}/),student=student[0],chrome.runtime.sendMessage({cmd:"Stu",data:student},function(e){})}catch(err){errorHandler("获取学号信息错误！",err)}chrome.runtime.sendMessage({key:"update"},function(e){console.log(e);try{upenabledvalue=e.upenabled}catch(t){upenabledvalue=0}nowver=e.nowver,upenabledvalue==1&&swal({title:"检测到主程序更新",text:"选课助手要更新啦~点击确定下载~记得安装哦！！\n\n当前版本："+e.nowver+"\n\n最新版本："+e.latestver+"\n\n为保证用户体验，插件需要更新才能使用哦~",type:"info",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"开始升级",cancelButtonText:"取消升级",closeOnCancel:!1},function(t){t?window.open(e.updateurl):swal({title:"取消升级",text:"为保证用户体验，插件需升级到最新版本才可使用，确认要取消吗？点击取消将打开升级页面",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"确定",cancelButtonText:"取消"},function(t){t||window.open(e.updateurl)})})}),chrome.runtime.sendMessage({key:"Genuine"},function(e){if(e==0)swal("主程序错误！","检测到插件被二次打包！\n为保护作者版权，请重新下载官方版本！\n下载地址："+res.updateurl,"error");else try{GetSubject(),chrome.runtime.sendMessage({key:"Getsettings"},function(e){e=e.split(","),Showscore=e[0],ShowGPA=e[1],Timecheck=e[2],permit=1,Showscore=="enabled"||ShowGPA=="enabled"?permit==1?(chrome.runtime.sendMessage({cmd:"clear"},function(e){}),Main()):permit==0&&(Showscore="disabled",ShowGPA="disabled",chrome.runtime.sendMessage({cmd:"clear"},function(e){}),Main()):(NProgress.done(),chrome.runtime.sendMessage({cmd:"clear"},function(e){}),Main())})}catch(t){errorHandler("主程序错误！",t)}});